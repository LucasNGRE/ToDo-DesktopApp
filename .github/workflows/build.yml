name: Build and Release

on:
  push:
    tags:
      - 'v*'  # ExÃ©cuter uniquement lors d'un tag versionnÃ© comme v1.0.0

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [macos-latest, windows-latest]  # Build sur macOS et Windows

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          npm install
          npm list  # VÃ©rifier les dÃ©pendances installÃ©es
          echo "âœ… Dependencies installed."

      - name: Debug GH_TOKEN  # Ã‰tape pour vÃ©rifier si le token est bien dÃ©fini
        run: |
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            if ($env:GH_TOKEN -eq $null) { Write-Host "âŒ GH_TOKEN is NOT set!" ; exit 1 } else { Write-Host "âœ… GH_TOKEN is set." }
          else
            if [ -z "$GH_TOKEN" ]; then
              echo "âŒ GH_TOKEN is NOT set!"
              exit 1
            else
              echo "âœ… GH_TOKEN is set."
            fi
          fi
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Build app
        run: |
          echo "âš™ï¸ Building application..."
          npm run build
          echo "âœ… Build process completed."

      - name: Upload release assets
        uses: actions/upload-artifact@v4
        with:
          name: release-build
          path: dist/

      - name: Debug Git & Tags  # VÃ©rifie l'Ã©tat de Git et les tags
        run: |
          echo "ğŸ“Œ Current Git branch and tags:"
          git branch -a
          git tag -l
          echo "âœ… Git setup verified."

      - name: Push release to GitHub
        run: |
          echo "ğŸš€ Creating release for tag ${{ github.ref_name }}..."
          git push origin ${{ github.ref_name }}
          echo "âœ… Release pushed."
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
