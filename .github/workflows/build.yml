name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Ex√©cuter uniquement lors d'un tag versionn√© comme v1.0.0

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [macos-latest, windows-latest]  # Build sur macOS et Windows

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install dependencies
        run: |
          echo "üì¶ Installing dependencies..."
          npm install
          npm list  # V√©rifier les d√©pendances install√©es
          echo "‚úÖ Dependencies installed."

      - name: Debug GH_TOKEN  # √âtape pour v√©rifier si le token est bien d√©fini
        run: |
          if [ "$RUNNER_OS" == "macOS" ]; then
            # Utilisation de zsh ou bash sur macOS
            echo "‚úÖ Running on macOS"
            if [ -z "$GH_TOKEN" ]; then
              echo "‚ùå GH_TOKEN is NOT set!"
              exit 1
            else
              echo "‚úÖ GH_TOKEN is set."
            fi
          elif [ "$RUNNER_OS" == "Windows" ]; then
            # PowerShell sur Windows
            echo "‚úÖ Running on Windows"
            if (-not $env:GH_TOKEN) {
              Write-Host "‚ùå GH_TOKEN is NOT set!"
              exit 1
            } else {
              Write-Host "‚úÖ GH_TOKEN is set."
            }
          fi
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Build app
        run: |
          echo "‚öôÔ∏è Building application..."
          npm run build
          echo "‚úÖ Build process completed."
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Upload release assets
        uses: actions/upload-artifact@v4
        with:
          name: release-build
          path: dist/

      - name: Debug Git & Tags  # V√©rifie l'√©tat de Git et les tags
        run: |
          echo "üìå Current Git branch and tags:"
          git branch -a
          git tag -l
          echo "‚úÖ Git setup verified."

      - name: Push release to GitHub
        run: |
          echo "üöÄ Creating release for tag ${{ github.ref_name }}..."
          git push origin ${{ github.ref_name }}
          echo "‚úÖ Release pushed."
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
